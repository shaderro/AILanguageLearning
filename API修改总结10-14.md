# API.js 修改总结 (2024-10-14)

## 📝 修改的文件

**文件路径**：`frontend/my-web-ui/src/services/api.js`

---

## 🔄 主要修改内容

### 1. ✅ 修改API服务器地址（第5行）

**修改前**：
```javascript
baseURL: "http://localhost:8000",  // Mock API
```

**修改后**：
```javascript
baseURL: "http://localhost:8001",  // ✅ 真实数据库API
```

**说明**：将前端连接从Mock服务器（8000）切换到真实数据库API（8001）

---

### 2. ✅ 增强响应拦截器（第25-43行）

**修改前**：
```javascript
api.interceptors.response.use(
  (response) => {
    return response.data;  // 直接返回
  }
);
```

**修改后**：
```javascript
api.interceptors.response.use(
  (response) => {
    // 数据库API返回格式: { success: true, data: {...} }
    if (response.data && response.data.success !== undefined) {
      return response.data.data;  // 返回内层data
    }
    return response.data;  // 其他格式直接返回
  }
);
```

**说明**：兼容数据库API的响应格式，自动提取内层数据

---

### 3. ✅ 更新Vocab API端点（第50-69行）

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| 获取列表 | `/api/vocab` | `/api/v2/vocab` ✅ |
| 获取详情 | `/api/vocab/{id}` | `/api/v2/vocab/{id}` ✅ |
| 搜索 | ❌ 无 | `/api/v2/vocab/search` ✅ 新增 |
| 创建 | ❌ 无 | `POST /api/v2/vocab` ✅ 新增 |
| 更新 | ❌ 无 | `PUT /api/v2/vocab/{id}` ✅ 新增 |
| 删除 | ❌ 无 | `DELETE /api/v2/vocab/{id}` ✅ 新增 |

**新增方法**：
- `searchVocab(keyword)` - 搜索词汇
- `createVocab(vocabData)` - 创建词汇
- `updateVocab(id, vocabData)` - 更新词汇
- `deleteVocab(id)` - 删除词汇

---

### 4. ✅ 更新Grammar API端点（第71-90行）

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| 获取列表 | `/api/grammar` | `/api/v2/grammar` ✅ |
| 获取详情 | `/api/grammar/{id}` | `/api/v2/grammar/{id}` ✅ |
| 搜索 | ❌ 无 | `/api/v2/grammar/search` ✅ 新增 |
| 创建 | ❌ 无 | `POST /api/v2/grammar` ✅ 新增 |
| 更新 | ❌ 无 | `PUT /api/v2/grammar/{id}` ✅ 新增 |
| 删除 | ❌ 无 | `DELETE /api/v2/grammar/{id}` ✅ 新增 |

**新增方法**：
- `searchGrammar(keyword)` - 搜索语法规则
- `createGrammar(grammarData)` - 创建语法规则
- `updateGrammar(id, grammarData)` - 更新语法规则
- `deleteGrammar(id)` - 删除语法规则

---

### 5. ✅ 更新Text/Article API端点（第92-107行）

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| 获取列表 | `/api/articles` | `/api/v2/texts` ✅ |
| 获取详情 | `/api/articles/{id}` | `/api/v2/texts/{id}?include_sentences=true` ✅ |
| 获取句子 | ❌ 无 | `/api/v2/texts/{id}/sentences` ✅ 新增 |
| 搜索 | ❌ 无 | `/api/v2/texts/search` ✅ 新增 |

**新增方法**：
- `getArticleSentences(textId)` - 获取文章的句子列表
- `searchArticles(keyword)` - 搜索文章

**重要变化**：
- 端点名称从 `articles` 改为 `texts`（匹配数据库命名）
- `getArticleById` 自动包含句子（`include_sentences=true`）

---

### 6. ⚠️ 保持不变的API

#### Asked Tokens API（第137-153行）
```javascript
// ⚠️ 保持不变，仍使用JSON文件存储
getAskedTokens: (userId, textId) => 
  api.get(`/api/user/asked-tokens?user_id=${userId}&text_id=${textId}`),

markTokenAsked: (...) => 
  api.post('/api/user/asked-tokens', {...}),
```

**原因**：数据结构未最终确定，暂不迁移到数据库

---

#### Session 和 Chat API（第155-191行）
```javascript
// ⚠️ 这些功能依赖Mock服务器的SessionState
session: {
  setSentence: ...,
  selectToken: ...,
  updateContext: ...,
  reset: ...
},

sendChat: (payload) => api.post("/api/chat", payload),
```

**注意**：这些端点在数据库API（8001）上不存在，调用会失败！

**解决方案**：
- 方案1：同时启动Mock服务器（8000），Session/Chat功能通过代理访问8000
- 方案2：将这些功能迁移到数据库版本
- 方案3：暂时不使用这些功能

---

### 7. ✅ 移除的功能

```javascript
// ❌ 已移除（数据库API不支持）
// toggleVocabStar: (id, isStarred) => ...
// toggleGrammarStar: (id, isStarred) => ...
```

**说明**：收藏功能在数据库API中可能未实现，已移除这些方法

---

## 📊 修改统计

| 类型 | 数量 | 说明 |
|------|------|------|
| 修改行数 | ~50行 | 主要是端点路径更新 |
| 新增方法 | 10个 | CRUD和搜索功能 |
| 修改端点 | 6个 | 从v1改为v2 |
| 保持不变 | 5个 | Asked Tokens、Session、Chat |
| 移除方法 | 2个 | Star收藏功能 |

---

## 🧪 测试验证

### 步骤1：启动数据库API
```powershell
cd C:\Users\Mayn\AILanguageLearning-main
python server.py
# 应该在 http://localhost:8001 启动
```

### 步骤2：启动前端
```powershell
cd C:\Users\Mayn\AILanguageLearning-main\frontend\my-web-ui
npm run dev
# 应该在 http://localhost:5173 启动
```

### 步骤3：检查浏览器控制台

**应该看到**：
```
🌐 API Request: GET /api/v2/vocab
✅ API Response: 200 /api/v2/vocab
```

**数据验证**：
- ✅ 词汇列表应显示29个真实词汇（来自数据库）
- ✅ 语法列表应显示8个真实规则（来自数据库）
- ✅ 文章列表应显示7篇真实文章（来自数据库）

---

## ⚠️ 已知问题和注意事项

### 问题1：Session/Chat功能不可用

**症状**：
```
❌ API Response Error: 404 /api/session/set_sentence
❌ API Response Error: 404 /api/chat
```

**原因**：数据库API（8001）不包含这些端点

**临时解决**：
如果需要使用这些功能，有两个选择：

#### 选项A：使用API代理层（推荐）
按照 `前后端集成方案对比10-14.md` 中的方案C实施，让Session/Chat请求路由到Mock服务器（8000）

#### 选项B：同时启动两个服务器（临时）
```powershell
# 终端1：数据库API（Vocab、Grammar、Text）
python server.py  # 端口8001

# 终端2：Mock API（Session、Chat）
cd frontend/my-web-ui/backend
python server_frontend_mock.py  # 端口8000
```

然后需要在前端代码中为不同功能指定不同的baseURL。

---

### 问题2：数据格式可能不匹配

**症状**：前端显示空白或undefined

**常见原因**：
- 数据库返回的字段名与前端组件期望的不同
- 例如：数据库返回 `vocab_body`，前端期望 `word`

**检查方法**：
1. 打开浏览器开发者工具 → Network标签
2. 查看API响应的实际数据结构
3. 对比前端组件中使用的字段名

**解决方案**：
- 修改前端组件使用正确的字段名
- 或在响应拦截器中添加字段映射

---

### 问题3：文章Token数据为空

**症状**：文章句子没有Token详情

**原因**：数据库API出于性能考虑，默认不返回Token详情（返回空tuple）

**解决方案**：
参考 `DATABASE_INTEGRATION_COMPLETE_SUMMARY.md` 中关于Token的说明，可能需要：
1. 实现TokenAdapter
2. 创建独立的Token API
3. 前端按需加载Token详情

---

## 📋 后续待办

### 短期（本周）
- [ ] 测试所有词汇功能（列表、详情、搜索、CRUD）
- [ ] 测试所有语法功能（列表、详情、搜索、CRUD）
- [ ] 测试所有文章功能（列表、详情、搜索）
- [ ] 验证数据持久化（创建数据后重启服务器仍存在）
- [ ] 记录发现的数据格式不匹配问题

### 中期（下周）
- [ ] 决定Session/Chat功能的处理方案
- [ ] 实施API代理层（如果需要混合模式）
- [ ] 处理数据格式不匹配问题
- [ ] 优化Token加载性能

### 长期（未来）
- [ ] Asked Tokens迁移到数据库（等数据结构确定）
- [ ] Dialogue迁移到数据库（等功能设计完成）
- [ ] 添加用户认证和管理
- [ ] 准备云端部署

---

## 🎯 预期效果

### 修改前（Mock数据）
```
前端 → http://localhost:8000 (Mock API)
           ↓
       假数据（临时，不持久化）
```

### 修改后（真实数据库）
```
前端 → http://localhost:8001 (数据库API)
           ↓
       SQLite数据库
           ↓
       29个词汇、8个语法、7篇文章（真实，持久化）
```

---

## ✅ 验收标准

修改成功的标志：

1. ✅ 前端启动无错误
2. ✅ 浏览器控制台显示请求到8001端口
3. ✅ 词汇页面显示29个真实词汇（不是Mock数据）
4. ✅ 语法页面显示8个真实规则（不是Mock数据）
5. ✅ 文章页面显示7篇真实文章（不是Mock数据）
6. ✅ 可以创建新词汇，刷新后仍然存在（数据持久化）
7. ✅ 可以搜索词汇/语法/文章
8. ✅ 可以编辑和删除数据

---

## 📞 需要帮助？

如果遇到问题，请检查：

1. **后端日志**：查看 `server.py` 的控制台输出
2. **前端控制台**：查看浏览器开发者工具的Console
3. **网络请求**：查看浏览器开发者工具的Network标签
4. **数据库文件**：确认 `database_system/data_storage/data/language_learning.db` 存在且有数据

---

**修改完成时间**：2024-10-14  
**修改人**：AI Assistant  
**测试状态**：待测试  
**版本**：v1.0

