## 前端“localhost 拒绝连接”问题排查与修复（2025-09-22）

### 结论
- 后端 8000 正常。
- 前端无法访问的核心原因：当前 Node.js 版本为 20.18.0，Vite 7 需要 Node 20.19+ 或 22.12+，导致开发服务器未正常启动或立即退出；同时 5173 端口冲突曾触发自动切换到 5174，但进程退出后端口不再监听。

### 处理步骤（按顺序执行）
1) 升级 Node.js 至 20.19+（或 22.12+）
   - 可使用本地安装包或 nvm-windows。
   - 升级后重开终端，确认：
     - `node -v` 显示 >= 20.19
     - `npm -v` 正常输出

2) 重新安装并启动前端（前台运行以观察日志）
   - 进入前端目录：
     - `cd frontend/my-web-ui`
   - 安装依赖：
     - `npm install`
   - 启动开发服务器（优先 5173）：
     - `npm run dev -- --host --port 5173`
   - 若提示 5173 被占用，改用 5174 并访问相同端口：
     - `npm run dev -- --host --port 5174`

3) 验证与排错
   - 观察终端是否出现：`Local: http://localhost:5173/`（或 5174）且进程保持运行。
   - 浏览器访问对应地址；如仍拒绝连接：
     - 检查 Windows 防火墙/安全软件是否阻止 Node/Vite 访问网络。
     - 在新终端验证端口与 HTTP：
       - `netstat -ano | Select-String ':5173'`（或 5174）
       - `curl http://localhost:5173`（或 5174）

### 备用信息
- Vite 配置：`frontend/my-web-ui/vite.config.js` 默认 `port: 5173, host: true`。
- 根目录 `vite.config.js` 设为 3000，仅对根级 Vite 项目有效；本前端项目使用子目录配置。
- 后端 API：`http://localhost:8000`，如前端报 API 错误，再检查前端调用的 API 基础地址是否一致。

### 本次问题回顾与根因
- 现象：浏览器访问 `http://localhost:5173` 或 `http://127.0.0.1:5173/5174` 提示“拒绝连接 (ERR_CONNECTION_REFUSED)”。
- 排查结论：多次尝试时，前端开发服务器并未真正运行在对应端口上（端口未监听或进程被中断）。
- 直接原因：在 PowerShell 中以绝对路径启动 npm 时遗漏调用运算符 `&`，导致命令未执行成功、Vite 未启动。
  - 错误示例：`"C:\\Program Files\\nodejs\\npm.cmd" run dev -- --host 0.0.0.0 --port 5173`
  - 正确示例：`& "C:\\Program Files\\nodejs\\npm.cmd" run dev -- --host 0.0.0.0 --port 5173`
- 叠加因素：
  - 早期 Node 版本过低（v20.18.0）不满足 Vite 要求（需 20.19+ 或 22.12+），曾导致 dev server 直接退出。
  - 端口占用时 Vite会自动切换端口（若未设置 strictPort），易造成“访问错误端口”的混淆。

### 建议与规范（避免再次发生）
- 在 PowerShell 中调用带空格路径的可执行文件时，务必使用调用运算符 `&` 并为路径加引号：
  - `& "C:\\Program Files\\nodejs\\npm.cmd" -v`
  - `& "C:\\Program Files\\nodejs\\npm.cmd" run dev -- --host 0.0.0.0 --port 5173`
- 更推荐的做法：先进入前端目录再直接使用 `npm` 脚本，减少路径/转义问题：
  - `cd frontend/my-web-ui`
  - `npm run dev -- --host 0.0.0.0 --port 5173`
- 启动后务必确认终端出现：`Local: http://localhost:5173/`，这是“端口已监听”的唯一可信标志。
- 若浏览器仍失败，立即用以下命令核实端口状态：
  - `netstat -aon | Select-String ':5173'`
  - 或 `netstat -aon | findstr :5173`
- 已在 `vite.config.js` 固定 `server.port=5173` 且 `strictPort=true`，端口冲突将报错而不会静默切换，便于快速定位。

### 手动启动步骤（可直接复制执行）
- 后端（简化版 server.py）
  - PowerShell：
    ```powershell
    cd C:\Users\ranxi\AILanguageLearning\frontend\my-web-ui\backend
    python server.py
    ```
  - 验证：浏览器打开 `http://localhost:8000/api/health` 应返回 `{"status":"ok"}`。

- 前端（Vite 开发服务器，固定 5173）
  - PowerShell（推荐，避免执行策略问题，注意 & 与引号）：
    ```powershell
    cd C:\Users\ranxi\AILanguageLearning\frontend\my-web-ui
    & "C:\Program Files\nodejs\npm.cmd" run dev -- --host 0.0.0.0 --port 5173
    ```
  - CMD（命令提示符）：
    ```cmd
    cd /d frontend\my-web-ui
    npm run dev -- --host 0.0.0.0 --port 5173
    ```
  - 成功标志：终端出现 `Local: http://localhost:5173/` 且进程不退出。

- 若端口拒绝连接但你已启动过：
  ```powershell
  # 结束残留进程（如有）
  taskkill /F /IM node.exe; taskkill /F /IM npm.exe
  # 重新按上述步骤启动
  ```

- 端口与连通性检查：
  ```powershell
  netstat -aon | Select-String ':5173'
  Invoke-WebRequest -UseBasicParsing http://localhost:5173
  ```

### AxiosError: Network Error 排查与修复
- 现象：前端页面显示 "AxiosError: Network Error"，API 请求失败。
- 根因：后端服务器未在 8000 端口运行，导致前端 axios 请求被拒绝连接。

- 快速诊断步骤：
  1) 检查后端是否在监听 8000 端口：
     ```powershell
     netstat -ano | findstr :8000
     ```
  2) 测试后端健康接口：
     ```powershell
     try { (Invoke-WebRequest -UseBasicParsing -Uri 'http://localhost:8000/api/health' -TimeoutSec 4).StatusCode } catch { 'ERR: ' + ($_.Exception.Message) }
     ```
  3) 浏览器直接访问：`http://localhost:8000/api/health`，应返回 `{"status":"ok"}`

- 修复方法：
  1) 启动后端服务器：
     ```powershell
     cd frontend/my-web-ui/backend
     python server.py
     ```
  2) 或使用最小化窗口启动：
     ```powershell
     cd frontend/my-web-ui/backend
     Start-Process -WindowStyle Minimized python -ArgumentList 'server.py'
     ```
  3) 验证后端启动成功：
     - 终端应显示：`INFO: Uvicorn running on http://0.0.0.0:8000`
     - 端口检查：`netstat -ano | findstr :8000` 应显示 LISTENING
     - 浏览器访问 `http://localhost:8000/api/health` 返回健康状态

- 验证修复：
  1) 刷新前端页面 `http://localhost:5173`
  2) Axios 错误应消失，API 请求正常
  3) 如仍有错误，检查浏览器控制台 Network 面板：
     - 请求 URL 是否为 `http://localhost:8000/api/...`
     - 错误状态码和具体错误信息
     - 是否存在 CORS 相关错误

- 常见问题：
  - 后端进程意外退出：重新启动 `python server.py`
  - 端口被其他程序占用：使用 `taskkill /F /IM python.exe` 清理后重启
  - CORS 错误：检查后端 `server.py` 中的 CORS 配置是否包含前端端口

### 附录：本次排查方法与建议
- 确认 Node 与 Vite 版本兼容性：
  - 现象：Vite 提示“Node.js 20.18.0，需 20.19+ 或 22.12+”。
  - 处理：使用 `winget upgrade -e --id OpenJS.NodeJS.LTS --silent` 升级到 v22.19.0。
  - 验证：
    - `node -v`（必要时以绝对路径调用：`"C:\\Program Files\\nodejs\\node.exe" -v`）
    - `npm -v`（必要时以绝对路径调用：`"C:\\Program Files\\nodejs\\npm.cmd" -v`）

- PowerShell 执行策略导致 `npm.ps1` 被阻止：
  - 现象：`npm : 无法加载文件 npm.ps1，因为在此系统上禁止运行脚本`
  - 处理：改用可执行的 `npm.cmd`、`npx.cmd`：
    - `& "C:\\Program Files\\nodejs\\npm.cmd" install`
    - `& "C:\\Program Files\\nodejs\\npx.cmd" vite --host --port 5173`

- 端口占用与固定端口：
  - 观察：Vite 在 5173 被占用时会自动切到 5174，若进程退出则端口不再监听导致浏览器“拒绝连接”。
  - 固定：在 `frontend/my-web-ui/vite.config.js` 设置：
    - `server.port = 5173`
    - `server.host = true`
    - `server.strictPort = true`（端口被占用时直接报错，不自动换端口）
  - 启动命令（前台查看日志）：
    - `npm run dev -- --host --port 5173`

- 验证监听与连通性：
  - 监听检查：`netstat -ano | Select-String ':5173'`
  - HTTP 探测：`curl http://localhost:5173` 或 `Invoke-WebRequest http://localhost:5173`
  - 成功标志：Vite 输出 `Local: http://localhost:5173/` 且进程保持运行。

- 防火墙/网络：
  - 首次启动时若有 Windows 防火墙弹窗，请允许 Node/Vite 的网络访问（至少私有网络）。
  - 若浏览器无法访问但进程在监听，优先排查防火墙或安全软件拦截。

- 端口策略建议：
  - 开发阶段建议固定 5173 并启用 `strictPort: true`，避免误访问错误端口。
  - 如需更换端口，统一到新端口并更新访问书签/脚本，避免混用。


