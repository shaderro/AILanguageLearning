# æ•°æ®åº“æ¥å…¥æƒ…å†µæ£€æŸ¥æŠ¥å‘Š

## ğŸ“Š å½“å‰çŠ¶æ€æ¦‚è§ˆ

### âœ… å·²å®Œæˆçš„æ•°æ®åº“é›†æˆï¼ˆå¯ç”¨ï¼‰

1. **Vocabï¼ˆè¯æ±‡ï¼‰** - å®Œæ•´æ”¯æŒ
   - âœ… æ•°æ®åº“ Modelï¼š`VocabExpression`
   - âœ… ä¸šåŠ¡ Managerï¼š`VocabManagerDB`
   - âœ… API è·¯ç”±ï¼š`/api/v2/vocab/*`
   - âœ… å‰ç«¯æ”¯æŒï¼š`apiService.getVocabList()` ç­‰

2. **Grammarï¼ˆè¯­æ³•è§„åˆ™ï¼‰** - å®Œæ•´æ”¯æŒ
   - âœ… æ•°æ®åº“ Modelï¼š`GrammarRule`
   - âœ… ä¸šåŠ¡ Managerï¼š`GrammarManagerDB`
   - âœ… API è·¯ç”±ï¼š`/api/v2/grammar/*`
   - âœ… å‰ç«¯æ”¯æŒï¼š`apiService.getGrammarList()` ç­‰

3. **Texts/Articlesï¼ˆæ–‡ç« ï¼‰** - å®Œæ•´æ”¯æŒ
   - âœ… æ•°æ®åº“ Modelï¼š`OriginalText`
   - âœ… ä¸šåŠ¡ Managerï¼š`OriginalTextManagerDB`
   - âœ… API è·¯ç”±ï¼š`/api/v2/texts/*`
   - âœ… å‰ç«¯æ”¯æŒï¼š`apiService.getArticlesList()` ç­‰

4. **Sentencesï¼ˆå¥å­ï¼‰** - å®Œæ•´æ”¯æŒ
   - âœ… æ•°æ®åº“ Modelï¼š`Sentence`ï¼ˆåŒ…å« tokens å…³ç³»ï¼‰
   - âœ… å­—æ®µï¼š`text_id`, `sentence_id`, `sentence_body`, `grammar_annotations`, `vocab_annotations`, `tokens`
   - âœ… APIï¼šé€šè¿‡ `/api/v2/texts/{id}/?include_sentences=true` è·å–

5. **Tokens** - å®Œæ•´æ”¯æŒ
   - âœ… æ•°æ®åº“ Modelï¼š`Token`
   - âœ… å­—æ®µå®Œæ•´ï¼š`token_body`, `token_type`, `difficulty_level`, `global_token_id`, `sentence_token_id`, `pos_tag`, `lemma`, `is_grammar_marker`, `linked_vocab_id`
   - âœ… å…³ç³»ï¼š`sentence` (åå‘), `linked_vocab` (åå‘)

6. **VocabExpressionExampleï¼ˆè¯æ±‡ä¾‹å¥ï¼‰** - å®Œæ•´æ”¯æŒ
   - âœ… æ•°æ®åº“ Modelï¼š`VocabExpressionExample`
   - âœ… å­—æ®µï¼š`vocab_id`, `text_id`, `sentence_id`, `context_explanation`, `token_indices`

7. **GrammarExampleï¼ˆè¯­æ³•ä¾‹å¥ï¼‰** - å®Œæ•´æ”¯æŒ
   - âœ… æ•°æ®åº“ Modelï¼š`GrammarExample`
   - âœ… å­—æ®µï¼š`rule_id`, `text_id`, `sentence_id`, `explanation_context`

8. **AskedTokenï¼ˆå·²æé—®æ ‡è®°ï¼‰** - å®Œæ•´æ”¯æŒ
   - âœ… æ•°æ®åº“ Modelï¼š`AskedToken`
   - âœ… å­—æ®µï¼š`user_id`, `text_id`, `sentence_id`, `sentence_token_id`, `type`, `vocab_id`, `grammar_id`
   - âœ… Managerï¼š`AskedTokensManager` æ”¯æŒ JSON å’Œæ•°æ®åº“åŒæ¨¡å¼

---

### âš ï¸ éƒ¨åˆ†å®Œæˆ/éœ€è¦è¡¥å……

9. **VocabNotation & GrammarNotationï¼ˆæ ‡æ³¨ç³»ç»Ÿï¼‰** - éƒ¨åˆ†å®Œæˆ
   - âœ… DTO å®šä¹‰ï¼š`data_classes_new.py` ä¸­å·²å®šä¹‰
   - âœ… Manager å®ç°ï¼š`VocabNotationManager`, `GrammarNotationManager` æ”¯æŒ JSON å’Œ SQLite
   - âœ… ç»Ÿä¸€æ¥å£ï¼š`UnifiedNotationManager`
   - âœ… API è·¯ç”±ï¼š`/api/v2/notations/vocab`, `/api/v2/notations/grammar`
   - âš ï¸ **æ•°æ®åº“è¡¨**ï¼šå½“å‰ä½¿ç”¨**ç‹¬ç«‹çš„ SQLite è¡¨**ï¼ˆé€šè¿‡ manager è‡ªå»ºï¼‰ï¼Œ**ä¸åœ¨ä¸» ORM models.py ä¸­**
   - âš ï¸ **çŠ¶æ€**ï¼šå¯ç”¨ä½†æœªä¸ä¸»æ•°æ®åº“ ORM é›†æˆ

---

## ğŸ”§ éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†

### 1. VocabNotation & GrammarNotation æ•°æ®åº“é›†æˆ

**å½“å‰çŠ¶æ€**ï¼š
- Manager å±‚å·²å®ç°ï¼ˆ`vocab_notation_manager.py`, `grammar_notation_manager.py`ï¼‰
- ä½¿ç”¨ç‹¬ç«‹çš„ SQLite è¡¨ï¼ˆåœ¨ manager çš„ `_init_database()` ä¸­åˆ›å»ºï¼‰
- æœªåœ¨ä¸» ORM `database_system/business_logic/models.py` ä¸­å®šä¹‰

**éœ€è¦è°ƒæ•´**ï¼š

#### é€‰é¡¹ Aï¼šåˆå¹¶åˆ°ä¸» ORMï¼ˆæ¨èï¼‰
åœ¨ `database_system/business_logic/models.py` æ·»åŠ ï¼š

```python
class VocabNotation(Base):
    __tablename__ = 'vocab_notations'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(String(255), nullable=False)
    text_id = Column(Integer, ForeignKey('original_texts.text_id', ondelete='CASCADE'), nullable=False)
    sentence_id = Column(Integer, nullable=False)
    token_id = Column(Integer, nullable=False)
    vocab_id = Column(Integer, ForeignKey('vocab_expressions.vocab_id', ondelete='CASCADE'))
    created_at = Column(DateTime, default=datetime.now, nullable=False)
    
    __table_args__ = (
        ForeignKeyConstraint(
            ['text_id', 'sentence_id'],
            ['sentences.text_id', 'sentences.sentence_id'],
            ondelete='CASCADE'
        ),
        UniqueConstraint('user_id', 'text_id', 'sentence_id', 'token_id', name='uq_vocab_notation')
    )

class GrammarNotation(Base):
    __tablename__ = 'grammar_notations'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(String(255), nullable=False)
    text_id = Column(Integer, ForeignKey('original_texts.text_id', ondelete='CASCADE'), nullable=False)
    sentence_id = Column(Integer, nullable=False)
    grammar_id = Column(Integer, ForeignKey('grammar_rules.rule_id', ondelete='CASCADE'))
    marked_token_ids = Column(JSON, nullable=False)
    created_at = Column(DateTime, default=datetime.now, nullable=False)
    
    __table_args__ = (
        ForeignKeyConstraint(
            ['text_id', 'sentence_id'],
            ['sentences.text_id', 'sentences.sentence_id'],
            ondelete='CASCADE'
        ),
        UniqueConstraint('user_id', 'text_id', 'sentence_id', name='uq_grammar_notation')
    )
```

ç„¶åæ›´æ–° Manager ä½¿ç”¨ ORM è€ŒéåŸå§‹ SQLã€‚

#### é€‰é¡¹ Bï¼šä¿æŒç‹¬ç«‹ SQLiteï¼ˆå½“å‰çŠ¶æ€ï¼‰
- ä¼˜ç‚¹ï¼šä¸éœ€è¦æ”¹åŠ¨ï¼Œå·²å¯ç”¨
- ç¼ºç‚¹ï¼šä¸ä¸»æ•°æ®åº“åˆ†ç¦»ï¼Œæ— æ³•åˆ©ç”¨å¤–é”®çº¦æŸå’Œçº§è”åˆ é™¤

---

### 2. æ•°æ®åº“è¡¨ç»“æ„å®Œæ•´æ€§æ£€æŸ¥

**å·²æœ‰è¡¨ï¼ˆORM models.pyï¼‰**ï¼š
- âœ… `vocab_expressions`
- âœ… `grammar_rules`
- âœ… `original_texts`
- âœ… `sentences`
- âœ… `tokens`
- âœ… `vocab_expression_examples`
- âœ… `grammar_examples`
- âœ… `asked_tokens`
- âœ… `users`

**ç‹¬ç«‹è¡¨ï¼ˆNotation Managersï¼‰**ï¼š
- âš ï¸ `vocab_notations` - ç‹¬ç«‹ SQLite
- âš ï¸ `grammar_notations` - ç‹¬ç«‹ SQLite

---

### 3. å‰ç«¯ API è°ƒç”¨æ£€æŸ¥

**å½“å‰å‰ç«¯ä½¿ç”¨çš„æ¨¡å¼**ï¼š
- é€šè¿‡ `api.js` çš„ `API_TARGET` åˆ‡æ¢ï¼ˆmock=8000, db=8001ï¼‰
- Mock æ¨¡å¼ï¼šä½¿ç”¨ JSON æ–‡ä»¶ï¼ˆ`server_frontend_mock.py`ï¼‰
- DB æ¨¡å¼ï¼šä½¿ç”¨æ•°æ®åº“ APIï¼ˆ`backend/api/*_routes.py`ï¼‰

**Notation ç›¸å…³è°ƒç”¨**ï¼š
```javascript
// å½“å‰å®ç°
getGrammarNotations: (textId) => 
  api.get(API_TARGET === 'mock' 
    ? `/api/grammar_notations/${textId}` 
    : `/api/v2/notations/grammar?text_id=${textId}`)

getVocabNotations: (textId) => 
  api.get(API_TARGET === 'mock' 
    ? `/api/vocab_notations/${textId}` 
    : `/api/v2/notations/vocab?text_id=${textId}`)
```

**çŠ¶æ€**ï¼šâœ… å‰ç«¯å·²é€‚é…åŒæ¨¡å¼

---

## ğŸ¯ æ¨èçš„è°ƒæ•´æ–¹æ¡ˆ

### ç«‹å³å¯åšï¼ˆä½é£é™©ï¼‰

1. **å°† VocabNotation å’Œ GrammarNotation åŠ å…¥ä¸» ORM**
   - åœ¨ `database_system/business_logic/models.py` æ·»åŠ ä¸¤ä¸ª Model
   - åˆ›å»ºå¯¹åº”çš„ CRUD æ“ä½œ
   - åˆ›å»ºå¯¹åº”çš„ Manager
   - æ›´æ–° API è·¯ç”±ä½¿ç”¨ ORM Session

2. **æ•°æ®è¿ç§»è„šæœ¬**
   - ç¼–å†™è„šæœ¬ä»ç‹¬ç«‹ SQLite è¿ç§»åˆ°ä¸»æ•°æ®åº“
   - æˆ–ä¿ç•™åŒæ¨¡å¼ï¼Œé€šè¿‡é…ç½®åˆ‡æ¢

### å¯é€‰ä¼˜åŒ–

3. **ç»Ÿä¸€ notation_routes.py ä½¿ç”¨æ•°æ®åº“**
   - å½“å‰ï¼š`get_unified_notation_manager(use_database=False)`
   - æ”¹ä¸ºï¼š`get_unified_notation_manager(use_database=True)`
   - éœ€è¦å…ˆå®Œæˆæ­¥éª¤1

4. **MainAssistant é›†æˆæ•°æ®åº“æ¨¡å¼**
   - å½“å‰ï¼šä½¿ç”¨ JSON æ–‡ä»¶
   - æ”¹ä¸ºï¼šå¯é€‰æ•°æ®åº“æ¨¡å¼
   - éœ€è¦æ›´æ–° `server_frontend_mock.py` çš„å…¨å±€ DataController

---

## ğŸ“ æ•°æ®ç»“æ„å¯¹æ¯”æ£€æŸ¥

### Token å­—æ®µå¯¹æ¯”

| DTO å­—æ®µ | æ•°æ®åº“ Model å­—æ®µ | çŠ¶æ€ |
|---------|----------------|------|
| `token_body` | `token_body` | âœ… |
| `token_type` | `token_type` | âœ… |
| `difficulty_level` | `difficulty_level` | âœ… |
| `global_token_id` | `global_token_id` | âœ… |
| `sentence_token_id` | `sentence_token_id` | âœ… |
| `pos_tag` | `pos_tag` | âœ… |
| `lemma` | `lemma` | âœ… |
| `is_grammar_marker` | `is_grammar_marker` | âœ… |
| `linked_vocab_id` | `linked_vocab_id` | âœ… |

**ç»“è®º**ï¼šâœ… å®Œå…¨å¯¹åº”ï¼Œæ— éœ€è°ƒæ•´

### VocabExpressionExample å­—æ®µå¯¹æ¯”

| DTO å­—æ®µ | æ•°æ®åº“ Model å­—æ®µ | çŠ¶æ€ |
|---------|----------------|------|
| `vocab_id` | `vocab_id` | âœ… |
| `text_id` | `text_id` | âœ… |
| `sentence_id` | `sentence_id` | âœ… |
| `context_explanation` | `context_explanation` | âœ… |
| `token_indices` | `token_indices` (JSON) | âœ… |

**ç»“è®º**ï¼šâœ… å®Œå…¨å¯¹åº”ï¼Œæ— éœ€è°ƒæ•´

---

## ğŸš€ è¡ŒåŠ¨å»ºè®®

### ä¼˜å…ˆçº§ 1ï¼ˆç«‹å³æ‰§è¡Œï¼‰
âœ… **æ— éœ€è°ƒæ•´** - å½“å‰æ•°æ®ç»“æ„å®Œå…¨å…¼å®¹ï¼Œå¯ç›´æ¥ä½¿ç”¨

### ä¼˜å…ˆçº§ 2ï¼ˆå»ºè®®å®Œæˆï¼‰
ğŸ“‹ **å°† Notation è¡¨é›†æˆåˆ°ä¸» ORM**
- æ·»åŠ  `VocabNotation` å’Œ `GrammarNotation` åˆ° `models.py`
- åˆ›å»º CRUD å’Œ Manager
- æ›´æ–° API è·¯ç”±ä½¿ç”¨ä¸»æ•°æ®åº“

### ä¼˜å…ˆçº§ 3ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
ğŸ”„ **ç»Ÿä¸€å­˜å‚¨æ¨¡å¼**
- å°†æ‰€æœ‰æ¨¡å—ä» JSON è¿ç§»åˆ°æ•°æ®åº“
- æˆ–ä¿ç•™åŒæ¨¡å¼æ”¯æŒï¼Œé€šè¿‡ç¯å¢ƒå˜é‡åˆ‡æ¢

---

## ğŸ“Œ æ€»ç»“

**å¥½æ¶ˆæ¯**ï¼šä½ çš„æ•°æ®ç»“æ„ä¿®æ”¹ï¼ˆToken, Sentence, VocabExample ç­‰ï¼‰å·²å®Œå…¨ä½“ç°åœ¨æ•°æ®åº“ä¸­ï¼Œ**æ— éœ€é¢å¤–è°ƒæ•´**ã€‚

**å¯é€‰æ”¹è¿›**ï¼šå°† VocabNotation å’Œ GrammarNotation ä»ç‹¬ç«‹ SQLite åˆå¹¶åˆ°ä¸» ORMï¼Œä»¥è·å¾—æ›´å¥½çš„æ•°æ®ä¸€è‡´æ€§å’Œå¤–é”®çº¦æŸã€‚

éœ€è¦æˆ‘ç°åœ¨æ‰§è¡Œä¼˜å…ˆçº§ 2 çš„é›†æˆå—ï¼Ÿ

