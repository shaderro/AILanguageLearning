# JSON到数据库迁移计划

## 📋 项目概述

将现有的JSON文件存储系统逐步迁移到SQLite数据库，提升系统性能、可维护性和数据一致性。

## 🎯 迁移目标

- 保持现有功能完整性
- 提升数据查询性能
- 增强数据一致性
- 简化数据管理
- 支持并发访问

## 📈 当前进度（滚动更新）

- [x] 数据库业务层重构：`database_system/business_logic` 已完成 CRUD 拆分、DAL 统一管理器、Managers 与 `UnifiedDataManager`
- [x] 代码通过基础 Lint 检查（新建模块）
- [ ] JSON → DB 核心数据迁移（进行中，见第二阶段）
- [ ] 后端 `backend/data/data_managers` 适配数据库（待做）
- [ ] Assistants 层改用 Data Managers（待做）
- [ ] FastAPI 接入 per-request Session 与依赖注入（待做）
- [ ] API 接口与前端联调（待做）

## 📊 当前数据结构分析

### JSON文件结构
```
backend/data/current/
├── vocab.json                    # 词汇数据
├── grammar.json                  # 语法规则
├── articles/                     # 文章数据
│   ├── text_*/                   # 文章目录
│   │   ├── original_text.json   # 文章元数据
│   │   ├── sentences.json       # 句子数据
│   │   └── tokens.json          # token数据
│   └── *_processed_*.json       # 单文件格式文章
└── asked_tokens/                # 已提问tokens
    └── {user_id}.json           # 用户提问记录
```

### 数据库表结构
```
- vocab_expressions              # 词汇表
- grammar_rules                  # 语法规则表
- original_texts                 # 文章表
- sentences                      # 句子表
- tokens                         # token表
- asked_tokens                   # 已提问tokens表
```

## 🚀 迁移计划

### 第一阶段：数据迁移准备 (1-2天)

#### 1.1 数据备份与验证
- [ ] 备份所有JSON文件到`backend/data/backup/`
- [ ] 验证JSON数据完整性
- [ ] 检查数据格式一致性
- [ ] 记录数据统计信息

#### 1.2 迁移工具开发
- [ ] 创建数据迁移脚本 `migrate_json_to_db.py`
- [ ] 实现数据验证功能
- [ ] 添加回滚机制
- [ ] 创建迁移日志系统

### 第二阶段：核心数据迁移 (2-3天)

#### 2.1 词汇数据迁移
- [ ] 迁移 `vocab.json` → `vocab_expressions`表
- [ ] 迁移词汇例句 → `vocab_expression_examples`表
- [ ] 验证词汇数据完整性
- [ ] 测试词汇查询功能

#### 2.2 语法规则迁移
- [ ] 迁移 `grammar.json` → `grammar_rules`表
- [ ] 迁移语法例句 → `grammar_examples`表
- [ ] 验证语法规则数据
- [ ] 测试语法查询功能

#### 2.3 文章数据迁移
- [ ] 迁移文章元数据 → `original_texts`表
- [ ] 迁移句子数据 → `sentences`表
- [ ] 迁移token数据 → `tokens`表
- [ ] 处理外键关联关系
- [ ] 验证文章数据完整性

#### 2.4 已提问tokens迁移
- [ ] 迁移 `asked_tokens/` → `asked_tokens`表
- [ ] 验证用户数据完整性
- [ ] 测试已提问tokens功能

### 第三阶段：后端适配 (3-4天)

#### 3.0 架构与边界（新增说明）
- 业务数据库层：`database_system/business_logic`（ORM models + CRUD + DAL + Managers + UnifiedDataManager）
- 后端 AI 逻辑层：`backend/data/data_managers`（领域 DTO：`data_classes_new.py`）
- 适配/映射层：负责 `models ↔ DTO` 双向转换，AI 层仅接触 DTO，以解耦数据库细节。

#### 3.1 数据管理器更新
- [x] 在 `database_system/business_logic` 内完成：CRUD 拆分、DAL 统一管理器、Managers 与 `UnifiedDataManager`
- [ ] 在 `backend/data/data_managers` 内：改为调用 `business_logic.managers` 完成读写
- [ ] 返回值统一用 `data_classes_new.py` 的 DTO（通过适配器转换）
- [ ] 若保留缓存（内存/Redis），补全失效策略与一致性
- [ ] `dialogue_record.py` 等历史模块改为数据库实现（事务与错误处理）

#### 3.2 API接口适配
- [ ] 更新 `backend/main.py` 中的API端点
- [ ] 修改数据控制器 `data_controller.py`
- [ ] 更新助手系统 `assistants/` 中的数据处理
- [ ] 修改前端API调用接口

（新增）会话/事务管理：
- [ ] FastAPI 依赖注入提供“每请求一个 Session”（从 `DatabaseManager` 获取 `Session`）
- [ ] 写操作统一包裹事务：成功 `commit`、失败 `rollback`，确保幂等点位（如 get_or_create）
- [ ] 数据库异常 → 业务错误映射（NotFound/Conflict/Validation），对外错误模型统一

#### 3.3 配置管理
- [ ] 统一数据库配置
- [ ] 添加数据库连接池
- [ ] 实现数据库健康检查
- [ ] 添加错误处理和重试机制

### 第四阶段：前端适配 (2-3天)

#### 4.1 API调用更新
- [ ] 修改前端API调用逻辑
- [ ] 更新数据加载方式
- [ ] 优化数据缓存策略
- [ ] 添加加载状态指示

#### 4.2 用户体验优化
- [ ] 实现数据懒加载
- [ ] 添加分页功能
- [ ] 优化搜索性能
- [ ] 改进错误提示

### 第五阶段：测试与优化 (2-3天)

#### 5.1 功能测试
- [ ] 词汇功能测试
- [ ] 语法功能测试
- [ ] 文章阅读功能测试
- [ ] 已提问tokens功能测试
- [ ] 对话功能测试

#### 5.2 性能测试
- [ ] 数据库查询性能测试
- [ ] 并发访问测试
- [ ] 内存使用优化
- [ ] 响应时间对比

#### 5.3 数据一致性验证
- [ ] 数据完整性检查
- [ ] 数据同步验证
- [ ] 外键关系验证
- [ ] 数据统计对比

### 第六阶段：清理与优化 (1-2天)

#### 6.1 代码清理
- [ ] 移除JSON文件处理代码
- [ ] 删除未使用的导入
- [ ] 优化代码结构
- [ ] 更新注释和文档

#### 6.2 配置优化
- [ ] 统一数据库配置
- [ ] 优化数据库连接
- [ ] 添加监控和日志
- [ ] 更新部署配置

## 🔧 技术实现要点

### 数据迁移策略
1. **增量迁移** - 支持部分数据迁移
2. **数据验证** - 确保迁移数据正确性
3. **回滚机制** - 支持迁移失败回滚
4. **进度跟踪** - 实时显示迁移进度

### 兼容性处理
1. **双模式支持** - 同时支持JSON和数据库
2. **配置切换** - 通过配置选择存储方式
3. **数据同步** - 确保数据一致性
4. **错误处理** - 优雅处理迁移错误

### 适配清单（新增，面向全面接入数据库）
- 模型/DTO 转换：
  - 建立 `adapters/orm_to_dto.py` 与 `dto_to_orm.py`（或合并为 `adapters.py`）
  - 统一主键/外键/枚举（如 `SourceType`）/时间戳的映射规则
- 会话与事务：
  - FastAPI 层提供 per-request `Session`，Managers/DAL 不自行创建会话
  - 写操作显式控制 `commit/rollback`，异常边界清晰
- data_managers 切换：
  - `backend/data/data_managers` 内部改为调用 `business_logic.managers`，对外仍返回 DTO
  - 若保留缓存，校准与 DB 的一致性与失效策略
- Assistants 适配：
  - 所有读/写词汇、语法、文章、标记的路径改走 data_managers（其内部已走 DB）
  - 校对幂等与重复创建，落实 DB 级唯一约束
- 错误与返回：
  - 标准化 NotFound/Conflict/Validation 等业务错误
  - 统一空值/缺字段策略，避免上层歧义
- 查询与分页：
  - 大结果集接口补充分页/排序，Managers 或 DAL 层统一策略
- 性能与索引：
  - 高频字段建索引（如 `vocab_body` 等）
  - 审视 ORM 预加载（`joinedload/selectinload`）以降低 N+1
- 一致性与约束：
  - 明确唯一约束、外键约束、软删策略，在 models 与逻辑中保持一致
- 日志与审计：
  - 关键写操作加日志；必要时补充审计字段 `created_by/updated_by`
- 测试与回归：
  - 使用测试数据库替换假数据来源；为 data_managers 与 assistants 写回归用例
- 文档与迁移：
  - 更新开发文档说明新入口；完善 JSON → DB 迁移与校验流程（防重/去重）

### 性能优化
1. **批量操作** - 使用批量插入提升性能
2. **索引优化** - 添加必要的数据库索引
3. **查询优化** - 优化复杂查询
4. **缓存策略** - 实现合理的数据缓存

## 📅 时间安排

| 阶段 | 预计时间 | 关键里程碑 |
|------|----------|------------|
| 第一阶段 | 1-2天 | 数据备份完成，迁移工具就绪 |
| 第二阶段 | 2-3天 | 核心数据迁移完成 |
| 第三阶段 | 3-4天 | 后端适配完成 |
| 第四阶段 | 2-3天 | 前端适配完成 |
| 第五阶段 | 2-3天 | 测试验证完成 |
| 第六阶段 | 1-2天 | 清理优化完成 |
| **总计** | **11-17天** | **系统完全迁移** |

## ⚠️ 风险控制

### 数据安全
- 完整的数据备份
- 迁移过程日志记录
- 数据验证机制
- 回滚方案准备

### 功能保障
- 分阶段迁移测试
- 功能回归测试
- 性能监控
- 用户反馈收集

### 技术风险
- 数据库连接稳定性
- 数据迁移完整性
- 性能影响评估
- 兼容性问题处理

## 📝 验收标准

### 功能验收
- [ ] 所有现有功能正常工作
- [ ] 数据查询性能提升
- [ ] 用户界面无变化
- [ ] 错误处理完善

### 性能验收
- [ ] 数据加载速度提升20%以上
- [ ] 并发访问支持
- [ ] 内存使用优化
- [ ] 数据库查询优化

### 数据验收
- [ ] 数据完整性100%
- [ ] 数据一致性验证通过
- [ ] 外键关系正确
- [ ] 数据统计准确

## 🎯 成功指标

1. **功能完整性** - 所有功能正常工作
2. **性能提升** - 查询速度提升20%以上
3. **数据准确性** - 数据迁移100%准确
4. **用户体验** - 界面响应速度提升
5. **系统稳定性** - 无数据丢失或损坏

---

**注意：session_state.py 是临时存储，不需要数据库持久化，保持现有实现即可。**
