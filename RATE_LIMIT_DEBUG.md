# é€Ÿç‡é™åˆ¶è°ƒè¯•æŒ‡å—

## ğŸ” é—®é¢˜

ç”¨æˆ·æŠ¥å‘Šåœ¨æ­£å¸¸ä½¿ç”¨æƒ…å†µä¸‹è§¦å‘äº†é€Ÿç‡é™åˆ¶ï¼ˆ429é”™è¯¯ï¼‰ï¼Œæ€€ç–‘æœ‰é‡å¤è¯·æ±‚ã€‚

## ğŸ“Š å½“å‰é€Ÿç‡é™åˆ¶é…ç½®

### `/api/chat` æ¥å£
- **é™åˆ¶**ï¼šæ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š **20 æ¬¡**
- **æ—¶é—´çª—å£**ï¼š60 ç§’

### å…¶ä»–æ¥å£ï¼ˆé»˜è®¤ï¼‰
- **é™åˆ¶**ï¼šæ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š **100 æ¬¡**
- **æ—¶é—´çª—å£**ï¼š60 ç§’

## ğŸ”§ å·²æ·»åŠ çš„è°ƒè¯•åŠŸèƒ½

### 1. è¯·æ±‚å†å²è®°å½•

é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶ç°åœ¨ä¼šè®°å½•æ¯ä¸ªç”¨æˆ·çš„è¯·æ±‚å†å²ï¼š
- è®°å½•æœ€è¿‘ 50 æ¡è¯·æ±‚
- åŒ…å«ï¼šæ—¶é—´æˆ³ã€è·¯å¾„ã€æ–¹æ³•ã€å‰©ä½™æ¬¡æ•°

### 2. è¯¦ç»†æ—¥å¿—

å½“è§¦å‘é™åˆ¶æ—¶ï¼Œä¼šè¾“å‡ºï¼š
- å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°
- æœ€è¿‘ 10 æ¡è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯

### 3. è­¦å‘Šæ—¥å¿—

å½“å‰©ä½™æ¬¡æ•°å°‘äº 5 æ¬¡æ—¶ï¼Œä¼šè¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚

## ğŸ“ å¦‚ä½•æŸ¥çœ‹è¯·æ±‚å†å²

### æ–¹æ³• 1ï¼šæŸ¥çœ‹åç«¯æ—¥å¿—

å½“è§¦å‘ 429 é”™è¯¯æ—¶ï¼Œåç«¯æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
```
ğŸš« [RateLimit] ç”¨æˆ· 5 è§¦å‘é™åˆ¶: POST /api/chat
   å½“å‰çª—å£å†…è¯·æ±‚æ•°: 20/20
   æœ€è¿‘ 10 æ¡è¯·æ±‚:
     14:23:45 POST /api/chat
     14:23:44 POST /api/chat
     ...
```

### æ–¹æ³• 2ï¼šæ·»åŠ è°ƒè¯•ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å®æ—¶æŸ¥çœ‹ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªè°ƒè¯•ç«¯ç‚¹ï¼š

```python
@app.get("/api/debug/rate-limit/{user_id}")
async def get_rate_limit_debug(user_id: int, current_user: User = Depends(get_current_user)):
    """è·å–ç”¨æˆ·çš„é€Ÿç‡é™åˆ¶çŠ¶æ€ï¼ˆä»…é™å½“å‰ç”¨æˆ·ï¼‰"""
    if current_user.user_id != user_id:
        raise HTTPException(403, "åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è¯·æ±‚å†å²")
    
    from backend.middleware.rate_limit import get_user_request_history, _rate_limit_storage
    
    history = get_user_request_history(user_id)
    storage = _rate_limit_storage.get(user_id, (0, 0.0))
    
    return {
        "user_id": user_id,
        "current_count": storage[0],
        "window_start": datetime.fromtimestamp(storage[1]).isoformat(),
        "recent_requests": [
            {
                "time": datetime.fromtimestamp(ts).isoformat(),
                "path": path,
                "method": method,
                "remaining": remaining
            }
            for ts, path, method, remaining in history[-20:]
        ]
    }
```

## ğŸ› å¯èƒ½çš„åŸå› 

### 1. å‰ç«¯é‡å¤è¯·æ±‚

**ç—‡çŠ¶**ï¼š
- React ç»„ä»¶å¤šæ¬¡æ¸²æŸ“å¯¼è‡´é‡å¤è°ƒç”¨
- useEffect ä¾èµ–é¡¹è®¾ç½®ä¸å½“
- äº‹ä»¶å¤„ç†å™¨è¢«å¤šæ¬¡ç»‘å®š

**æ£€æŸ¥æ–¹æ³•**ï¼š
- æŸ¥çœ‹æµè§ˆå™¨ Network æ ‡ç­¾
- æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„è¯·æ±‚

### 2. è‡ªåŠ¨é‡è¯•æœºåˆ¶

**ç—‡çŠ¶**ï¼š
- è¯·æ±‚å¤±è´¥åè‡ªåŠ¨é‡è¯•
- ç½‘ç»œé”™è¯¯å¯¼è‡´å¤šæ¬¡é‡è¯•

**æ£€æŸ¥æ–¹æ³•**ï¼š
- æŸ¥çœ‹å‰ç«¯æ˜¯å¦æœ‰é‡è¯•é€»è¾‘
- æ£€æŸ¥ axios çš„ retry é…ç½®

### 3. å¤šä¸ªæ ‡ç­¾é¡µ/è®¾å¤‡

**ç—‡çŠ¶**ï¼š
- ç”¨æˆ·åŒæ—¶æ‰“å¼€å¤šä¸ªæ ‡ç­¾é¡µ
- å¤šä¸ªè®¾å¤‡åŒæ—¶ä½¿ç”¨

**è¯´æ˜**ï¼š
- é€Ÿç‡é™åˆ¶æ˜¯æŒ‰ç”¨æˆ·IDè®¡ç®—çš„
- å¤šä¸ªæ ‡ç­¾é¡µ/è®¾å¤‡ä¼šå…±äº«åŒä¸€ä¸ªé™åˆ¶

### 4. åå°ä»»åŠ¡/è½®è¯¢

**ç—‡çŠ¶**ï¼š
- å®šæ—¶åˆ·æ–°æ•°æ®
- WebSocket é‡è¿å¯¼è‡´å¤šæ¬¡è¯·æ±‚

**æ£€æŸ¥æ–¹æ³•**ï¼š
- æŸ¥çœ‹æ˜¯å¦æœ‰ setInterval æˆ–è½®è¯¢é€»è¾‘

## ğŸ” æ’æŸ¥æ­¥éª¤

1. **æŸ¥çœ‹åç«¯æ—¥å¿—**
   - æ‰¾åˆ°è§¦å‘ 429 é”™è¯¯æ—¶çš„æ—¥å¿—
   - æŸ¥çœ‹æœ€è¿‘ 10 æ¡è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯

2. **æŸ¥çœ‹æµè§ˆå™¨ Network æ ‡ç­¾**
   - è¿‡æ»¤ `/api/chat` è¯·æ±‚
   - æŸ¥çœ‹æ—¶é—´çº¿ï¼Œç¡®è®¤æ˜¯å¦æœ‰é‡å¤è¯·æ±‚

3. **æ£€æŸ¥å‰ç«¯ä»£ç **
   - æœç´¢æ‰€æœ‰è°ƒç”¨ `/api/chat` çš„åœ°æ–¹
   - æ£€æŸ¥ useEffect ä¾èµ–é¡¹
   - æ£€æŸ¥äº‹ä»¶å¤„ç†å™¨

4. **æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨é‡è¯•**
   - æŸ¥çœ‹ axios é…ç½®
   - æŸ¥çœ‹é”™è¯¯å¤„ç†é€»è¾‘

## ğŸ’¡ å»ºè®®

1. **æ·»åŠ è¯·æ±‚å»é‡**
   - å¦‚æœçŸ­æ—¶é—´å†…å‘é€ç›¸åŒè¯·æ±‚ï¼Œå–æ¶ˆä¹‹å‰çš„è¯·æ±‚

2. **ä¼˜åŒ–å‰ç«¯é€»è¾‘**
   - é¿å…ä¸å¿…è¦çš„é‡å¤è¯·æ±‚
   - ä½¿ç”¨ React Query çš„ç¼“å­˜æœºåˆ¶

3. **è°ƒæ•´é™åˆ¶å€¼**
   - å¦‚æœç¡®è®¤æ˜¯æ­£å¸¸ä½¿ç”¨ï¼Œå¯ä»¥é€‚å½“æé«˜é™åˆ¶
   - ä½†è¦æ³¨æ„é˜²æ­¢æ»¥ç”¨

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `backend/middleware/rate_limit.py` - é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶
- `frontend/my-web-ui/src/services/api.js` - API æœåŠ¡
- `frontend/my-web-ui/src/modules/article/components/ChatView.jsx` - èŠå¤©ç»„ä»¶
