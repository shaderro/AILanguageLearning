# 解决卡顿问题10/26.md

## 🔍 问题分析

### 当前状态
前端Article View页面存在明显的卡顿问题，疑似由频繁的API调用导致。

### 发现的API调用问题

## 📊 API调用分析

### 1. 页面初始化时的API调用

#### 1.1 ArticleViewer组件
- **useArticle(articleId)** - 获取文章详情
  - 调用：`/api/articles/{id}` (mock) 或 `/api/v2/texts/{id}/?include_sentences=true` (db)
  - 频率：页面加载时1次
  - 状态：✅ 正常

#### 1.2 useAskedTokens Hook
- **getAskedTokens(userId, articleId)** - 获取已提问的tokens
  - 调用：`/api/user/asked-tokens?user_id={userId}&text_id={articleId}`
  - 频率：页面加载时1次
  - 状态：✅ 正常

#### 1.3 useGrammarNotations Hook
- **getGrammarNotations(textId)** - 获取语法标注列表
  - 调用：`/api/grammar_notations/{textId}` (mock) 或 `/api/v2/notations/grammar?text_id={textId}` (db)
  - 频率：页面加载时1次
  - 状态：✅ 正常

### 2. 用户交互时的API调用

#### 2.1 TokenNotation组件 ⚠️ 问题组件
- **getVocabExampleByLocation(textId, sentenceId, tokenIndex)** - 获取词汇例句
  - 调用：`/api/vocab-example-by-location?text_id={textId}&sentence_id={sentenceId}&token_index={tokenIndex}`
  - 频率：**每次显示TokenNotation时调用**
  - 触发条件：`useEffect([isVisible, textId, sentenceId, tokenIndex])`
  - 问题：**频繁调用，每次hover都可能触发**

#### 2.2 GrammarNotationCard组件 ⚠️ 问题组件
- **getSentenceGrammarRules(textId, sentenceId)** - 获取句子语法规则
  - 调用：`/api/grammar_notations/{textId}/{sentenceId}` (mock) 或 `/api/v2/notations/grammar/{textId}/{sentenceId}` (db)
  - 频率：**每次显示GrammarNotationCard时调用**
  - 触发条件：`useEffect([isVisible, textId, sentenceId])`
  - 问题：**频繁调用，每次hover都可能触发**

#### 2.3 SentenceContainer组件 ⚠️ 问题组件
- **直接fetch调用** - 获取语法例句
  - 调用：`/api/grammar_examples/{articleId}/{sentenceId}`
  - 频率：**每次点击句子时调用**
  - 触发条件：`handleSentenceClick`
  - 问题：**每次点击都调用，没有缓存**

### 3. 重复调用问题

#### 3.1 多个组件同时调用相同API
- **GrammarNotationCard** 和 **useGrammarNotations** 都在调用语法相关的API
- **TokenNotation** 在每次显示时都重新获取数据，没有缓存

#### 3.2 缺乏缓存机制
- 所有API调用都没有缓存
- 相同参数的请求会重复发送
- 没有使用React Query的缓存功能

## 🚨 主要问题

### 1. 频繁的API调用
- **TokenNotation**: 每次hover都调用API
- **GrammarNotationCard**: 每次hover都调用API  
- **SentenceContainer**: 每次点击都调用API

### 2. 缺乏缓存
- 没有使用React Query缓存
- 相同数据重复请求
- 没有防抖机制

### 3. 组件设计问题
- 组件在每次显示时都重新获取数据
- 没有数据预加载
- 没有loading状态管理

## 💡 解决方案

### 1. 立即修复（高优先级）

#### 1.1 添加防抖机制
```javascript
// 在TokenNotation和GrammarNotationCard中添加防抖
const debouncedFetch = useMemo(
  () => debounce(fetchData, 300),
  [textId, sentenceId, tokenIndex]
)
```

#### 1.2 使用React Query缓存
```javascript
// 将API调用迁移到React Query
const { data, isLoading } = useQuery({
  queryKey: ['vocab-example', textId, sentenceId, tokenIndex],
  queryFn: () => apiService.getVocabExampleByLocation(textId, sentenceId, tokenIndex),
  enabled: isVisible && !!textId && !!sentenceId && tokenIndex !== null,
  staleTime: 5 * 60 * 1000, // 5分钟缓存
})
```

#### 1.3 数据预加载
```javascript
// 在ArticleViewer中预加载所有需要的数据
const { data: grammarNotations } = useQuery({
  queryKey: ['grammar-notations', articleId],
  queryFn: () => apiService.getGrammarNotations(articleId),
  staleTime: 10 * 60 * 1000,
})
```

### 2. 中期优化（中优先级）

#### 2.1 组件重构
- 将API调用逻辑提取到自定义Hook
- 使用Context共享数据
- 实现数据懒加载

#### 2.2 性能优化
- 使用React.memo防止不必要的重渲染
- 使用useMemo缓存计算结果
- 使用useCallback缓存函数引用

### 3. 长期优化（低优先级）

#### 3.1 架构改进
- 实现数据层抽象
- 使用状态管理库（如Zustand）
- 实现离线缓存

## 🎯 具体修复步骤

### 步骤1: 修复TokenNotation组件
1. 添加防抖机制
2. 使用React Query缓存
3. 添加loading状态

### 步骤2: 修复GrammarNotationCard组件
1. 添加防抖机制
2. 使用React Query缓存
3. 优化显示逻辑

### 步骤3: 修复SentenceContainer组件
1. 移除直接fetch调用
2. 使用React Query
3. 添加错误处理

### 步骤4: 整体优化
1. 统一API调用方式
2. 添加全局loading状态
3. 实现数据预加载

## 📈 预期效果

### 性能提升
- API调用次数减少80%
- 页面响应速度提升50%
- 用户体验显著改善

### 代码质量
- 更好的错误处理
- 更清晰的代码结构
- 更好的可维护性

## 🔧 实施建议

### 优先级排序
1. **高优先级**: TokenNotation和GrammarNotationCard的防抖和缓存
2. **中优先级**: SentenceContainer的API调用优化
3. **低优先级**: 整体架构优化

### 测试策略
1. 使用浏览器开发者工具监控网络请求
2. 测试不同交互场景的性能
3. 验证缓存机制的有效性

---

**创建时间**: 2025-10-26  
**问题状态**: 待修复  
**负责人**: 开发团队  
**预计完成时间**: 1-2天
